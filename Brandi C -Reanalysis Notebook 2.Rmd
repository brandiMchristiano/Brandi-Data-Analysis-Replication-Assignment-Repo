---
title: "Brandi C- Reanalysis Notebook 2"
author: "BMC"
date: "4/14/2021"
output: html_document
---


# Getting Started 
```{r}
# Read in data from CSV Files
g <- read.csv("genotypes.csv")
head(g)

k <- read.csv("kinship.csv")
head(k)
```

```{r}
# Read in data from R data set

# I somehow have to get my data in to knit it 
("new_bonds_data.rdata")
head(dyads)
head(events)
head(rates)
head(trials)
```


```{r}
# Load Packages Used 
library(sna)
library(tidyverse)
library(boot)
library(lme4)
library(lmerTest)
library(gridExtra)
library(asnipe)
library(cowplot)
library(MuMIn)
library(ggplot2)
```


```{r}
# Set cowplot as theme
theme_set(theme_cowplot())
```

# Descriptive Statistical Analysis

## 41 bats were used in this study
```{r}
# Number of bats 
# Each bat is used as a receiver and an actor therefore either of these would suffice
length(unique(dyads$receiver)) 
length(unique(dyads$actor))

```

## Bats were captured from two different sites in Panama : Tole and Las Pavas

### I had to filter by actor becasue the actors were only listed once and were compared to each reciever
```{r}
# Filtering from the dyads data frame, actor population
# Number of bats captured from Tole 
length(unique(dyads$actor[which(dyads$a.pop=="tole")])) 
# 19 bats were captured from Tole
```
```{r}
# Number of bats captured from Las Pavas
length(unique(dyads$actor[which(dyads$a.pop=="las.pavas")])) 
# 8 bats were captured from Las Pavas
```

## The remaining 14 bats were captive born bats 
```{r}
length(unique(dyads$actor[which(dyads$a.pop=="captive-born")]))
```

## There were 1,214 possible new relationships among all the bats
```{r}
length(unique(dyads$dir.dyad[which(dyads$new.dyad)])) # filters through the dyads data frame and picks out dyads where the relationship between the two individuals is a new paring (new.dyad=TRUE)
```
# Possibile grooming rate versus Actual grooming rates
```{r}
# Possible grooming rates
groom.rate1 <- rates %>%  #filters the rates data frame for any behavior marked as grooming ("g")
  filter(behav=="g") %>% 
  nrow()
groom.rate1
# There 32,928 possible grooming opportunities

# Actual grooming rates
groom.rate2 <- rates %>% #filters the rates data frame for any behavior marked as grooming ("g") is greater than 0
  filter(behav=="g") %>% 
  filter(rate>0) %>% 
  nrow()
groom.rate2
# Grooming actually occurred 3,056 times


# Probability of two bats grooming eachother in a trial
groom.rate3 <- groom.rate2/groom.rate1
groom.rate3

```

## There are 17,621 chances for a bat to recieve a donation
```{r}
feed.pos <- rates %>% filter(behav=="f") %>% nrow()  # behav is in the rates dataset
feed.pos
```
## However, during trial, only 668 bats donated food to another bat
```{r}
feed.act <- rates %>% filter(behav=="f") %>% filter(rate>0) %>% nrow() 
feed.act
```
## There is a 3.8% probability that an individual will donate its food to another individual. This is not taking into account any type of relationship or association. 
```{r}
feed.probability <- feed.act/feed.pos
feed.probability

```



```{r}
rates %>%  
  filter(behav=="f"| behav=="g") %>%
  filter(new.dyad) %>% 
  filter(rate>0) %>% 
  group_by(undir.dyad, behav) %>% 
  summarize(latency= min(days.together)) %>% 
  spread(key=behav, value=latency) %>% 
  mutate(diff= f-g) %>% 
  mutate(same= diff==0) %>% 
  pull(same) %>% 
  mean(na.rm=T)
```



```{r}
# This is the time until two unfamiliar individuals to share food for the first time
time.to.sharing <- 
  rates %>%  
  filter(behav=="f") %>%
  filter(new.dyad) %>% 
  filter(rate>0) %>% 
  group_by(undir.dyad) %>% 
  summarize(time.to.sharing= min(days.together)) %>% 
  pull() 
time.to.sharing
mean(time.to.sharing)
hist((time.to.sharing), main="Time it Took Unfamilar Individuals to Share Food with Eachother")
```

```{r}
time.to.groom <- 
  rates %>%  
  filter(behav=="g") %>%
  filter(new.dyad) %>% 
  filter(rate>0) %>% 
  group_by(undir.dyad) %>% 
  summarize(time.to.groom= min(days.together)) %>% 
  pull()
mean(time.to.groom)
hist((time.to.groom), main="Time it Took Unfamilar Individuals to Groonm Eachother")
```


```{r}
# To find the confidence intervals of these events, they boot strapped 10000 samples
boot_ci <- function(x, perms=10000) {
  mean.w=function(x,w) sum(x*w)
  numNA <- sum(is.na(x))
  x <- as.vector(na.omit(x))
  mean <- mean(x)
  boot <- boot.ci(boot(data=x, statistic=mean.w, R=perms, stype="w"), type="basic")
  low <- boot$basic[1,4]
  high <- boot$basic[1,5]
  c(low=low,mean=mean,high=high, N=round(length(x)))
}
```

```{r}
# CI of Time Until First New Sharing
boot_ci(time.to.sharing)

plot1 <- (boxplot((time.to.sharing), main= "Time Until First New Sharing"))
```

```{r}
# CI of Time Unitl First Grooming
boot_ci(time.to.groom)

boxplot((time.to.groom), main= "Time Until First Grooming")
```


```{r}
# Comparison of the two
par(mfrow = c(1, 2))
boxplot((time.to.groom),main="Time Until First Grooming")
boxplot((time.to.sharing), main = "Time Until First Food Sharing")
```


```{r}
# Practice one from analysis
plot2 <- 
  rates %>% 
  filter(period== "big cage") %>%
  filter(behav=="g") %>%
  filter(new.dyad) %>% 
  filter(!is.na(sharing.colony)) %>% 
  filter(before.first.donation | is.na(before.first.donation)) %>% 
  mutate(rate3= (rev.groom.rate>0)*1) %>% 
  ggplot(aes(x=date,y=rate3, group=sharing))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"))

plot2
```

```{r}
fig2.1 <- rates %>% 
  filter(behav=="g") %>%
   filter(new.dyad) %>%
  filter(period== "big cage") %>% # this is when they were in groups with unfamilar individuals
  filter(!is.na(sharing.colony)) %>% # makes non NA into true values
  filter(before.first.donation | is.na(before.first.donation)) %>% 
  mutate(rate3= (rev.groom.rate>0)*1) %>% 
  ggplot(aes(x=date,y=rate3, group=sharing))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"))+xlab("time")+ylab("probability of being groomed in a trial (before first donation")

fig2.1

```




