---
title: "Brandi C- Reanalysis Notebook 2"
author: "BMC"
date: "4/14/2021"
output: html_document
---


# Getting Started 
```{r}
# Read in data from CSV Files
g <- read.csv("genotypes.csv")
head(g)

k <- read.csv("kinship.csv")
head(k)
```

```{r}
# Read in data from R data set

# I somehow have to get my data in to knit it 
load("new_bonds_data.rda")
head(dyads)
head(events)
head(rates)

head(trials)
```


```{r}
# Load Packages Used 
library(sna)
library(tidyverse)
library(boot)
library(lme4)
library(lmerTest)
library(gridExtra)
library(asnipe)
library(cowplot)
library(MuMIn)
library(ggplot2)
library(mosaic)
```


```{r}
# Set cowplot as theme
theme_set(theme_cowplot())
```

# Descriptive Statistical Analysis

## 41 bats were used in this study
```{r}
# Number of bats 
# Each bat is used as a receiver and an actor therefore either of these would suffice
length(unique(dyads[,2]))
length(unique(dyads[,1]))

```

## Bats were captured from two different sites in Panama : Tole and Las Pavas

### I had to filter by actor becasue the actors were only listed once and were compared to each reciever
```{r}
# Filtering from the dyads data frame, actor population
# Number of bats captured from Tole 
length(unique(dyads[,1][which(dyads$a.pop=="tole")])) 
# 19 bats were captured from Tole
```
```{r}
# Number of bats captured from Las Pavas
length(unique(dyads[,1][which(dyads$a.pop=="las.pavas")])) 
# 8 bats were captured from Las Pavas
```

## The remaining 14 bats were captive born bats 
```{r}
length(unique(dyads[,1][which(dyads$a.pop=="captive-born")]))
```

## There were 1,214 possible new relationships among all the bats
```{r}
length(unique(dyads[,3][which(dyads$new.dyad)])) # filters through the dyads data frame and picks out dyads where the relationship between the two individuals is a new paring (new.dyad=TRUE) (directed dyad)
```
# Possibile grooming rate versus Actual grooming rates
```{r}
# Possible grooming rates
groom.rate1 <- nrow(rates %>%  #filters the rates data frame for any behavior marked as grooming ("g")
  filter(behav=="g"))
groom.rate1
# There 32,928 possible grooming opportunities

# Actual grooming rates
groom.rate2 <- nrow(rates %>% #filters the rates data frame for any behavior marked as grooming ("g") is greater than 0
  filter(behav=="g") %>% 
  filter(rate>0)) 
groom.rate2
# Grooming actually occurred 3,056 times


# Probability of two bats grooming eachother in a trial
groom.rate3 <- groom.rate2/groom.rate1
groom.rate3

```

## There are 17,621 chances for a bat to recieve a donation
```{r}
feed.pos <- nrow(rates %>% filter(behav=="f"))  # behav is in the rates dataset
feed.pos
```
## However, during trial, only 668 bats donated food to another bat
```{r}
feed.act <- nrow(rates %>% filter(behav=="f") %>% filter(rate>0))
feed.act
```
## There is a 3.8% probability that an individual will donate its food to another individual. This is not taking into account any type of relationship or association. 
```{r}
feed.probability <- feed.act/feed.pos
feed.probability

```




```{r}
# This is the time until two unfamiliar individuals to share food for the first time
time.to.sharing <- pull(
  rates %>%  
  filter(behav=="f") %>%
  filter(new.dyad) %>% 
  filter(rate>0) %>% 
  group_by(undir.dyad) %>% 
  summarize(time.to.sharing= min(days.together)))
mean(time.to.sharing)
hist((time.to.sharing), main="Time it Took Unfamilar Individuals to Share Food with Eachother")
```

```{r}
time.to.groom <- pull(
  rates %>%  
  filter(behav=="g") %>%
  filter(new.dyad) %>% 
  filter(rate>0) %>% 
  group_by(undir.dyad) %>% 
  summarize(time.to.groom= min(days.together)))
mean(time.to.groom)
hist((time.to.groom), main="Time it Took Unfamilar Individuals to Groonm Eachother")
```


```{r}
# To find the confidence intervals of these events, they boot strapped 10000 samples
boot_ci <- function(x, perms=10000) {
  mean.w=function(x,w) sum(x*w)
  numNA <- sum(is.na(x))
  x <- as.vector(na.omit(x))
  mean <- mean(x)
  boot <- boot.ci(boot(data=x, statistic=mean.w, R=perms, stype="w"), type="basic")
  low <- boot$basic[1,4]
  high <- boot$basic[1,5]
  c(low=low,mean=mean,high=high, N=round(length(x)))
}
# tring to play with this on my own

s <- rates
n_boot <- 10000
boot <- vector(length = n_boot) # set up a dummy variable to hold our simulations
n <- length(s)
# number of bootstrap samples will be the same length as our sample data
for (i in 1:10000) {
  boot[[i]] <- mean(sample(s, n, replace = TRUE))
}

```

```{r}
# CI of Time Until First New Sharing
boot_ci(time.to.sharing)

plot1 <- (boxplot((time.to.sharing), main= "Time Until First New Sharing"))
```

```{r}
# CI of Time Unitl First Grooming
boot_ci(time.to.groom)

boxplot((time.to.groom), main= "Time Until First Grooming")
```


```{r}
# Comparison of the two
par(mfrow = c(1, 2))
boxplot((time.to.groom),main="Time Until First Grooming")
boxplot((time.to.sharing), main = "Time Until First Food Sharing")
```
# Data Visualization 

```{r} 
# Figure 2 part 1
fig2.1 <- rates %>% 
  filter(behav=="g") %>%
   filter(new.dyad) %>%
  filter(period== "big cage") %>% # this is when they were in groups with unfamilar individuals
  filter(!is.na(sharing.colony)) %>% # makes non NA into true values
  filter(before.first.donation | is.na(before.first.donation)) %>% 
  mutate(rate3= (rev.groom.rate>0)*1) %>% 
  ggplot(aes(x=date,y=rate3, group=sharing))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"))+xlab("time")+ylab("probability of being groomed in a trial (before first donation")

fig2.1

```


```{r}
fig2.2<- rates %>% 
  filter(behav=="g") %>%
  filter(new.dyad) %>%
  filter(period== "big cage") %>%
  filter(adult.dyad) %>%
  filter(!is.na(sharing)) %>% # filter out everything that is not NA in sharing ... aka everything that is sharing
  filter(before.first.donation |is.na(before.first.donation)) %>% 
  mutate(rate3= (rev.groom.rate2>0)*1) %>% 
  ggplot(aes(date,rate3, group=sharing))+
  geom_smooth(method = "glm", method.args = list(family = "binomial"))+ # Authors state they used generalized linear models (glm)
  xlab("time")
fig2.2

# I don't really understand how to change the dashed and solid lines. The dashed line should represent individuals not sharing
```

```{r}
fig2.3 <- rates %>% 
   filter(behav=="g") %>%
  filter(new.dyad) %>% 
  filter(period== "big cage") %>%
   filter(!adult.dyad) %>% # looking at new young adults so filter out everything that's not an established adult dyad. 
  filter(!is.na(sharing)) %>% 
  filter(before.first.donation | is.na(before.first.donation)) %>% 
  mutate(rate3= (rev.groom.rate>0)*1) %>% 
  ggplot(aes(x=date,y=rate3, group=sharing))+
  geom_smooth(method = "glm",method.args = list(family = "binomial"))+ # showing the standard errors 
  ylab("probability of being groomed in a trial (before first donation)")+
  xlab("time")

fig2.3

# Once I figured out what was going on in the first plot, the other two were easier tp recreate. They were exactly the same but with an additional filter.
```
```{r}
grid.arrange(fig2.1, fig2.2, fig2.3, ncol=3)
```






# Infrenetial Statistical Analysis

## Create a data frame that filters out Tole bats that are in the mixed group 
## Filter by feeding behavior
```{r}
feedingbehavTole <- as.data.frame(
  rates %>% 
  filter(behav=="f") %>%
  filter(a.pop== "tole") %>% 
  filter(adult.dyad) %>% 
  filter(period== "big cage") %>%
  filter(!is.na(sharing.colony)) %>% 
  mutate(samepop= a.pop==r.pop) %>%
  group_by(actor, dir.dyad, samepop) %>% 
  summarise(rate=mean(rate2)))
feedingbehavTole
```

```{r}
library(mosaic)
```

```{r}
perms <- 10000
fit <- summary(lm(rate~samepop, data=feedingbehavTole))
fit
# B=0.09, p=0.03, n=390
#I got the same beta value of 0.09. I did not get the same p value, however, both are significant. Carter et al. got a p value of 0.003 and I got a p value of 0.03... which is pretty close. 

```



```{r}
groomingbehavTole <- as.data.frame(
  rates %>% 
  filter(adult.dyad) %>% 
  filter(period== "big cage") %>%
  filter(behav=="g") %>%
  filter(a.pop== "tole") %>% 
  filter(!is.na(sharing.colony)) %>% 
  mutate(samepop2= a.pop==r.pop) %>%
  group_by(actor, dir.dyad, samepop2) %>% 
  summarise(rate=mean(rate2)))
groomingbehavTole
```
```{r}
perms <- 10000
fit2 <- summary(lm(rate~samepop2, data=groomingbehavTole))
fit2
nrow(groomingbehavTole)
# B = 0.103 , p=0.14, n=390
```



```{r}
feedingbehavPavas <- as.data.frame(
  rates %>% 
  filter(behav=="f") %>%
  filter(a.pop== "las.pavas") %>% 
  filter(adult.dyad) %>% 
  filter(period== "big cage") %>%
  filter(!is.na(sharing.colony)) %>% 
  mutate(samepop= a.pop==r.pop) %>%
  group_by(actor, dir.dyad, samepop) %>% 
  summarise(rate=mean(rate2)))
feedingbehavPavas
```

```{r}
perms <- 10000
fit3 <- summary(lm(rate~samepop, data=feedingbehavPavas))
fit3
nrow(groomingbehavTole)
nrow(feedingbehavPavas)
# B=0.28, p=0.0001, n=160
```

```{r}
groomingbehavPavas <- as.data.frame(
  rates %>% 
  filter(behav=="g") %>%
  filter(a.pop== "las.pavas") %>% 
  filter(adult.dyad) %>% 
  filter(period== "big cage") %>%
  filter(!is.na(sharing.colony)) %>% 
  mutate(samepop= a.pop==r.pop) %>%
  group_by(actor, dir.dyad, samepop) %>% 
  summarise(rate=mean(rate2)))
groomingbehavPavas
```

```{r}
perms <- 10000
fit4 <- summary(lm(rate~samepop, data=groomingbehavPavas))
fit4
nrow(groomingbehavPavas)
# B=0.53, p<0.0001, n=160
```


